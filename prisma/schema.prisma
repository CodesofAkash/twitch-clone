// prisma/schema.prisma - COMPLETE UPDATED SCHEMA

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_DATABASE_URL")
}

model User {
  id             String   @id @default(uuid())
  username       String   @unique
  imageUrl       String
  externalUserId String   @unique
  bio            String?
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  following  Follow[] @relation("Following")
  followers  Follow[] @relation("Follower")
  blocking   Block[]  @relation("Blocking")
  blockedBy  Block[]  @relation("BlockedBy")
  stream     Stream?

  @@index([username])
}

model Category {
  id          String   @id @default(uuid())
  name        String   @unique
  slug        String   @unique
  imageUrl    String
  description String?
  isPredefined Boolean @default(false) // True for system categories, false for user-created
  isActive    Boolean  @default(true)  // Can be disabled by admins
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  streams     Stream[]

  @@index([slug])
  @@index([isPredefined])
}

model Tag {
  id        String   @id @default(uuid())
  name      String   @unique
  slug      String   @unique
  createdAt DateTime @default(now())

  streams   StreamTag[]

  @@index([slug])
}

model Stream {
  id                   String   @id @default(uuid())
  name                 String
  thumbnailUrl         String?
  ingressId            String?  @unique
  serverUrl            String?
  streamKey            String?
  isLive               Boolean  @default(false)
  isChatEnabled        Boolean  @default(true)
  isChatDelayed        Boolean  @default(false)
  isChatFollowersOnly  Boolean  @default(false)
  
  // Category relationship
  categoryId           String?
  category             Category? @relation(fields: [categoryId], references: [id], onDelete: SetNull)
  
  // Viewer metrics
  viewerCount          Int      @default(0)
  peakViewerCount      Int      @default(0)
  totalViewTime        Int      @default(0) // In seconds
  streamStartedAt      DateTime?
  
  userId               String   @unique
  user                 User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  // Tags (many-to-many)
  tags                 StreamTag[]
  
  createdAt            DateTime @default(now())
  updatedAt            DateTime @updatedAt

  @@index([userId])
  @@index([ingressId])
  @@index([categoryId])
  @@index([isLive])
}

model StreamTag {
  id       String @id @default(uuid())
  streamId String
  tagId    String

  stream Stream @relation(fields: [streamId], references: [id], onDelete: Cascade)
  tag    Tag    @relation(fields: [tagId], references: [id], onDelete: Cascade)

  @@unique([streamId, tagId])
  @@index([streamId])
  @@index([tagId])
}

model Follow {
  id          String @id @default(uuid())
  followerId  String
  followingId String

  follower  User @relation(name: "Following", fields: [followerId], references: [id], onDelete: Cascade)
  following User @relation(name: "Follower", fields: [followingId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@unique([followerId, followingId])
  @@index([followerId])
  @@index([followingId])
}

model Block {
  id        String @id @default(uuid())
  blockerId String
  blockedId String

  blocker User @relation(name: "Blocking", fields: [blockerId], references: [id], onDelete: Cascade)
  blocked User @relation(name: "BlockedBy", fields: [blockedId], references: [id], onDelete: Cascade)

  @@unique([blockerId, blockedId])
  @@index([blockerId])
  @@index([blockedId])
}

model Suggestion {
  id          String   @id @default(uuid())
  name        String
  email       String
  title       String
  description String
  category    String   // "feature" | "bug" | "improvement"
  createdAt   DateTime @default(now())

  @@index([createdAt])
}